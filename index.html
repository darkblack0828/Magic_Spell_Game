
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>魔法咒語猜詞遊戲</title>
  <style>
    body { font-family:"Noto Sans TC",sans-serif; text-align:center; padding:30px; background:#fafafa; }
    h1 { margin-bottom:20px; }
    button { margin:6px; padding:12px 24px; font-size:22px; border-radius:12px; border:2px solid #444; background:white; cursor:pointer; }
    #words, #chosen, #result, #timer, #postTimer { margin-top:20px; font-size:24px; }
    .word-btn { display:inline-block; margin:8px; padding:20px 36px; font-size:32px; border-radius:14px; border:2px solid #444; background:white; cursor:pointer; }
    .big-label { font-size:28px; font-weight:bold; margin:20px 0; display:block; }
    #chosen { font-size:40px; font-weight:bold; color:#111; margin-top:30px; }
    .stop { background:#f87171; color:white; }
    select, input[type=number] { font-size:20px; padding:5px; margin:5px; }
    #debug { display:none; }
  </style>
</head>
<body>
  <h1>魔法咒語猜詞遊戲</h1>

  <div id="settings">
    倒數時間：<input type="number" id="timeInput" value="4" min="1" max="10"> 分鐘<br>
    玩家數：<input type="number" id="playerCount" value="6" min="4" max="10"><br>
    狼人數：<select id="wolfCount"><option value="1">1</option><option value="2">2</option></select><br>
  </div>

  <button id="startBtn" onclick="start()">開始遊戲</button>

  <div id="stage"></div>
  <div id="words"></div>
  <div id="chosen"></div>
  <div id="timer"></div>
  <div id="result"></div>
  <div id="postTimer"></div>
  <div id="debug"></div>

  <script>
    let DATA = null;

    const audioFiles = [
      ["準備", "準備.mp3"],
      ["主持人身分", "主持人身分.mp3"],
      ["主持人閉上眼睛", "主持人閉上眼睛.mp3"],
      ["狼人睜開眼睛", "狼人睜開眼睛.mp3"],
      ["狼人閉上眼睛", "狼人閉上眼睛.mp3"],
      ["預言家睜開眼睛", "預言家睜開眼睛.mp3"],
      ["預言家閉上眼睛", "預言家閉上眼睛.mp3"],
      ["魔法咒語", "魔法咒語.mp3"],
      ["遊戲開始", "遊戲開始.mp3"],
      ["猜到", "猜到.mp3"],
      ["未猜到", "未猜到.mp3"],
      ["時間到", "時間到.mp3"]
    ];
    audioFiles.forEach(([id, src]) => {
      const a = document.createElement("audio");
      a.id = id;
      a.src = src;
      document.body.appendChild(a);
    });

    fetch("題庫.json")
      .then(r => r.json())
      .then(json => { DATA = json; console.log("題庫載入完成", DATA); })
      .catch(err => { alert("題庫載入失敗！請確認題庫.json 已放在根目錄"); });

    const MODE_COUNTS = {
      easy: { "易": 3, "中": 1, "難": 1 },
      medium: { "易": 1, "中": 3, "難": 1 },
      hard: { "易": 1, "中": 1, "難": 3 }
    };

    let currentBatch = [];
    let selectedWord = null;
    let countdown = null;
    let timeLeft = 0;
    let timers = [];
    let isActive = false;
    let postCountdown = null;
    let postTimeLeft = 0;
    let lastSuccess = null;

    function playAudio(id) {
      document.querySelectorAll('audio').forEach(a => { try { a.pause(); a.currentTime=0; } catch(e){} });
      const a = document.getElementById(id);
      if (a) { try { a.currentTime=0; a.play(); } catch(e){} }
    }
    function later(ms, fn) {
      const id = setTimeout(() => { if (!isActive) return; fn(); }, ms);
      timers.push(id);
      return id;
    }
    function clearAllTimers() { timers.forEach(clearTimeout); timers = []; }
    function stopAllAudio() { document.querySelectorAll('audio').forEach(a => { try { a.pause(); a.currentTime=0; } catch(e){} }); }
    function choice(arr) { return arr[Math.floor(Math.random()*arr.length)]; }
    function shuffle(a) { const arr=a.slice(); for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }

    function start() {
      if (!DATA) { alert("題庫尚未載入完成！"); return; }
      isActive = true;
      document.getElementById("settings").style.display = "none";
      const startBtn = document.getElementById("startBtn");
      startBtn.outerHTML = "<button id='stopBtn' class='stop' onclick='stopGame()'>停止</button>";

      document.getElementById("result").innerHTML = "";
      document.getElementById("words").innerHTML = "";
      document.getElementById("chosen").innerHTML = "";
      document.getElementById("timer").innerHTML = "";
      document.getElementById("stage").innerHTML = "準備中...";
      document.getElementById("postTimer").innerHTML = "";

      stopAllAudio(); clearAllTimers();

      playAudio("準備");
      later(5000, () => {
        playAudio("主持人身分");
        document.getElementById("stage").innerHTML = "<span class='big-label'>請選擇主持人身分：</span>" +
          "<button class='word-btn' onclick=\"chooseRole('seer')\">預言家</button> " +
          "<button class='word-btn' onclick=\"chooseRole('wolf')\">狼人</button> " +
          "<button class='word-btn' onclick=\"chooseRole('villager')\">村民</button>";
      });
    }

    function chooseRole(role) {
      if (!isActive) return;
      document.getElementById("stage").innerHTML = "";
      playAudio("魔法咒語");
      const mode = calculateDifficulty(role);
      drawMode(mode);
    }

    function calculateDifficulty(role) {
      let roleScore = 0;
      if (role === "seer") roleScore = 0;
      if (role === "wolf") roleScore = 0.5;
      if (role === "villager") roleScore = 1.5;

      const players = parseInt(document.getElementById("playerCount").value);
      const wolves = parseInt(document.getElementById("wolfCount").value);
      let playerParam = players - wolves * 3;
      let playerScore = 0;
      if (playerParam < 1) playerScore = 0;
      else if (playerParam === 1) playerScore = 0;
      else if (playerParam === 2) playerScore = 0.75;
      else if (playerParam === 3) playerScore = 1.5;
      else if (playerParam > 3) playerScore = 1.5;

      const rand = (Math.random() * 2 - 1);
      const total = roleScore + playerScore + rand;

      let mode = "medium";
      if (total < 1) {
        mode = "easy";
      } else if (total > 3) {
        mode = "hard";
      } else if (total >= 1 && total < 2) {
        const probMedium = total - 1;
        let pEasy = 1 - probMedium;
        let pMedium = probMedium;
        pMedium = Math.max(0, pMedium - 0.1);
        pEasy = 1 - pMedium;
        if (Math.random() < pMedium) mode = "medium";
        else mode = "easy";
      } else if (total >= 2 && total <= 3) {
        const probHard = total - 2;
        let pMedium = 1 - probHard;
        let pHard = probHard;
        pMedium = Math.max(0, pMedium - 0.1);
        pHard = 1 - pMedium;
        if (Math.random() < pHard) mode = "hard";
        else mode = "medium";
      }
      return mode;
    }

    function drawMode(mode) {
      const counts = MODE_COUNTS[mode];
      const diffsOrdered = Object.entries(counts).sort((a,b)=>b[1]-a[1]).map(x=>x[0]);
      const usedCats = new Set(); const batch = [];
      for (const diff of diffsOrdered) {
        let need = counts[diff];
        let categories = Object.keys(DATA[diff]||{}).filter(c => (DATA[diff][c]||[]).length>0 && !usedCats.has(c));
        categories = shuffle(categories).slice(0, need);
        for (const c of categories) {
          const w = choice(DATA[diff][c]);
          batch.push({word:w, category:c, difficulty:diff});
          usedCats.add(c);
        }
      }
      currentBatch = batch;
      renderBatch();
    }

    function renderBatch() {
      const container = document.getElementById("words");
      container.innerHTML = "<span class='big-label'>請選擇魔法咒語：</span>";
      currentBatch.forEach(item => {
        const btn = document.createElement("button");
        btn.className = "word-btn";
        btn.textContent = item.word;
        btn.onclick = () => selectWord(item);
        container.appendChild(btn);
      });
    }

    function selectWord(item) {
      if (!isActive) return;
      selectedWord = item;
      document.getElementById("words").innerHTML = "";
      document.getElementById("chosen").innerHTML = "咒語：" + selectedWord.word;
      nightFlow();
    }

    function nightFlow() {
      playAudio("主持人閉上眼睛");
      later(5000, () => {
        playAudio("狼人睜開眼睛");
        document.getElementById("chosen").innerHTML = "咒語：" + selectedWord.word;
        later(8000, () => {
          playAudio("狼人閉上眼睛");
          document.getElementById("chosen").innerHTML = "";
          later(5000, () => {
            playAudio("預言家睜開眼睛");
            document.getElementById("chosen").innerHTML = "咒語：" + selectedWord.word;
            later(8000, () => {
              playAudio("預言家閉上眼睛");
              document.getElementById("chosen").innerHTML = "";
              later(5000, () => {
                playAudio("遊戲開始");
                document.getElementById("result").innerHTML = "遊戲開始！";
                startCountdown();
              });
            });
          });
        });
      });
    }

    function startCountdown() {
      let minutes = parseInt(document.getElementById("timeInput").value);
      if (isNaN(minutes) || minutes < 1) minutes = 4;
      if (minutes > 10) minutes = 10;
      timeLeft = minutes * 60;
      updateTimer();
      countdown = setInterval(() => {
        if (!isActive) return;
        timeLeft--;
        updateTimer();
        if (timeLeft <= 0) {
          clearInterval(countdown);
          endGame(false);
        }
      }, 1000);
      document.getElementById("words").innerHTML = "<button class='word-btn' onclick='guessed()'>猜對了</button>";
    }

    function updateTimer() {
      const m = Math.floor(timeLeft / 60);
      const s = timeLeft % 60;
      document.getElementById("timer").innerHTML = "剩餘時間：" + m + "分 " + (s<10?"0":"") + s + "秒";
    }

    function guessed() {
      if (!isActive) return;
      if (countdown) clearInterval(countdown);
      endGame(true);
    }

    function endGame(success) {
      isActive = false;
      clearAllTimers();
      stopAllAudio();
      if (countdown) clearInterval(countdown);
      document.getElementById("timer").innerHTML = "";
      document.getElementById("words").innerHTML = "";
      const stopBtn = document.getElementById("stopBtn");
      if (stopBtn) {
        stopBtn.outerHTML = "<button id='startBtn' onclick='resetGame()'>再來一次</button>";
      }
      const hasWord = selectedWord && selectedWord.word;
      lastSuccess = success;
      if (success && hasWord) {
        playAudio("猜到");
        document.getElementById("result").innerHTML = "你們猜到魔法咒語了！✨<br>咒語是：「" + selectedWord.word + "」";
      } else if (hasWord) {
        playAudio("未猜到");
        document.getElementById("result").innerHTML = "你們沒有找到魔法咒語 😢<br>正確咒語是：「" + selectedWord.word + "」";
      } else {
        document.getElementById("result").innerHTML = "本輪已停止。";
      }
      if (hasWord) startPostCountdown();
    }

    function startPostCountdown() {
      postTimeLeft = 60;
      updatePostTimer();
      postCountdown = setInterval(() => {
        postTimeLeft--;
        updatePostTimer();
        if (postTimeLeft <= 0) {
          clearInterval(postCountdown);
          playAudio("時間到");
          document.getElementById("postTimer").innerHTML = "⏰ 時間到！";
        }
      }, 1000);
    }

    function updatePostTimer() {
      if (lastSuccess) {
        document.getElementById("postTimer").innerHTML = "狼人找出預言家剩餘時間：" + (postTimeLeft<10?"0":"") + postTimeLeft + "秒";
      } else {
        document.getElementById("postTimer").innerHTML = "所有人找出狼人剩餘時間：" + (postTimeLeft<10?"0":"") + postTimeLeft + "秒";
      }
    }

    function stopGame() { endGame(false); }

    function resetGame() {
      isActive = false;
      clearAllTimers();
      stopAllAudio();
      if (countdown) clearInterval(countdown);
      if (postCountdown) clearInterval(postCountdown);
      countdown = null;
      postCountdown = null;
      selectedWord = null;
      currentBatch = [];
      document.getElementById("stage").innerHTML = "";
      document.getElementById("words").innerHTML = "";
      document.getElementById("chosen").innerHTML = "";
      document.getElementById("timer").innerHTML = "";
      document.getElementById("result").innerHTML = "";
      document.getElementById("postTimer").innerHTML = "";
      document.getElementById("settings").style.display = "block";
      const btn = document.getElementById("startBtn");
      btn.textContent = "開始遊戲";
      btn.onclick = start;
    }
  </script>
</body>
</html>
