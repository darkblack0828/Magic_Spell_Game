<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>é­”æ³•å’’èªçŒœè©éŠæˆ²ï¼ˆv19b, é¡å¤–é¡Œåº«åµéŒ¯å¼·åŒ–ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family:"Noto Sans TC",sans-serif; text-align:center; padding:30px; background:#fafafa; }
    h1 { margin-bottom:20px; }
    button { margin:6px; padding:12px 24px; font-size:22px; border-radius:12px; border:2px solid #444; background:white; cursor:pointer; }
    #words, #chosen, #result, #timer, #postTimer { margin-top:20px; font-size:24px; }
    .word-btn { display:inline-block; margin:8px; padding:20px 36px; font-size:32px; border-radius:14px; border:2px solid #444; background:white; cursor:pointer; }
    .big-label { font-size:28px; font-weight:bold; margin:20px 0; display:block; }
    #chosen { font-size:40px; font-weight:bold; color:#111; margin-top:30px; }
    .stop { background:#f87171; color:white; }
    select, input[type=number] { font-size:20px; padding:5px; margin:5px; }
    #loading { font-size:18px; color:#555; margin-bottom:10px; }
    #diag { font-size:14px; color:#444; white-space:pre-wrap; text-align:left; max-width:960px; margin:20px auto; background:#fff; border:1px dashed #ccc; padding:10px; border-radius:8px; display:none; }
  </style>
</head>
<body>
  <h1>é­”æ³•å’’èªçŒœè©éŠæˆ²</h1>
  <div id="loading">é¡Œåº«è¼‰å…¥ä¸­â€¦</div>

  <div id="settings" style="display:none">
    å€’æ•¸æ™‚é–“ï¼š<input type="number" id="timeInput" value="4" min="1" max="10"> åˆ†é˜
    &nbsp;ç©å®¶æ•¸ï¼š<input type="number" id="playerCount" value="6" min="4" max="10">
    &nbsp;ç‹¼äººæ•¸ï¼š<select id="wolfCount"><option value="1">1</option><option value="2">2</option></select><br>
  </div>

  <button id="startBtn" onclick="start()" style="display:none">é–‹å§‹éŠæˆ²</button>
  <button id="diagBtn" style="display:none" onclick="toggleDiag()">é¡¯ç¤º/éš±è—åµéŒ¯è³‡è¨Š</button>

  <div id="stage"></div>
  <div id="words"></div>
  <div id="chosen"></div>
  <div id="timer"></div>
  <div id="result"></div>
  <div id="postTimer"></div>

  <div id="diag"></div>

  <script>
    // ===== è³‡æºè¼‰å…¥ï¼ˆé¡Œåº« + é¡å¤–é¡Œåº« + èªéŸ³ï¼‰ =====
    let DATA = { "æ˜“": {}, "ä¸­": {}, "é›£": {} };
    let assetsReady = false;
    const diag = [];
    function logd(...args){ console.log(...args); try{ diag.push(args.map(a=>typeof a==='string'?a:JSON.stringify(a)).join(' ')); }catch(e){ diag.push(args.join(' ')); } }

    // è¨ˆæ•¸å™¨ï¼šçµ±è¨ˆå¾ä¸»é¡Œåº«/é¡å¤–é¡Œåº«å„æ–°å¢äº†å¤šå°‘è©
    const addedCounts = { base: { "æ˜“":0, "ä¸­":0, "é›£":0 }, extra: { "æ˜“":0, "ä¸­":0, "é›£":0 } };
    let currentSourceKey = "base"; // 'base' or 'extra'

    function mergeIntoData(src, treatAsAllDiff=false) {
      if (!src) return;
      function addWord(diff, cat, word) {
        if (!word || !cat || !String(word).trim()) return; // å¿½ç•¥ç©ºå­—ä¸²/ç©ºç™½
        if (!DATA[diff][cat]) DATA[diff][cat] = [];
        if (!DATA[diff][cat].includes(word)) {
          DATA[diff][cat].push(word);
          if (addedCounts[currentSourceKey] && addedCounts[currentSourceKey][diff] !== undefined) {
            addedCounts[currentSourceKey][diff]++;
          }
        }
      }
      if (!treatAsAllDiff && (src["æ˜“"] || src["ä¸­"] || src["é›£"])) {
        ["æ˜“","ä¸­","é›£"].forEach(d => {
          const byCat = src[d] || {};
          Object.keys(byCat).forEach(cat => {
            const arr = Array.isArray(byCat[cat]) ? byCat[cat] : [];
            arr.forEach(w => addWord(d, cat, w));
          });
        });
      } else {
        if (Array.isArray(src)) {
          src.forEach((w, idx) => {
            ["æ˜“","ä¸­","é›£"].forEach(d => addWord(d, String(idx), w));
          });
        } else {
          Object.keys(src).forEach(cat => {
            const v = src[cat];
            const arr = Array.isArray(v) ? v : (Array.isArray(v?.words) ? v.words : []);
            ["æ˜“","ä¸­","é›£"].forEach(d => { arr.forEach(w => addWord(d, cat, w)); });
          });
        }
      }
    }

    function countTotals() {
      const out = { "æ˜“": {cats:0, words:0}, "ä¸­": {cats:0, words:0}, "é›£": {cats:0, words:0} };
      ["æ˜“","ä¸­","é›£"].forEach(d => {
        const map = DATA[d];
        const cats = Object.keys(map);
        out[d].cats = cats.length;
        out[d].words = cats.reduce((sum, c) => sum + (Array.isArray(map[c]) ? map[c].length : 0), 0);
      });
      return out;
    }

    // å‹•æ…‹å»ºç«‹èªéŸ³å…ƒç´ 
    const audioFiles = [
      ["æº–å‚™", "æº–å‚™.mp3"],
      ["ä¸»æŒäººèº«åˆ†", "ä¸»æŒäººèº«åˆ†.mp3"],
      ["ä¸»æŒäººé–‰ä¸Šçœ¼ç›", "ä¸»æŒäººé–‰ä¸Šçœ¼ç›.mp3"],
      ["ç‹¼äººçœé–‹çœ¼ç›", "ç‹¼äººçœé–‹çœ¼ç›.mp3"],
      ["ç‹¼äººé–‰ä¸Šçœ¼ç›", "ç‹¼äººé–‰ä¸Šçœ¼ç›.mp3"],
      ["é è¨€å®¶çœé–‹çœ¼ç›", "é è¨€å®¶çœé–‹çœ¼ç›.mp3"],
      ["é è¨€å®¶é–‰ä¸Šçœ¼ç›", "é è¨€å®¶é–‰ä¸Šçœ¼ç›.mp3"],
      ["é­”æ³•å’’èª", "é­”æ³•å’’èª.mp3"],
      ["éŠæˆ²é–‹å§‹", "éŠæˆ²é–‹å§‹.mp3"],
      ["çŒœåˆ°", "çŒœåˆ°.mp3"],
      ["æœªçŒœåˆ°", "æœªçŒœåˆ°.mp3"],
      ["æ™‚é–“åˆ°", "æ™‚é–“åˆ°.mp3"]
    ];
    function setupAudios() {
      audioFiles.forEach(([id, src]) => {
        const a = document.createElement("audio");
        a.id = id;
        a.src = src;
        document.body.appendChild(a);
      });
    }

    // å…·æœ‰ fallback èˆ‡ cache-busting çš„ fetch
    async function fetchWithFallback(paths){
      const ts = Date.now();
      for (const p of paths){
        const url = p + "?v=" + ts; //é¿å…èˆŠå¿«å–
        try{
          const res = await fetch(url, {cache:"no-store"});
          if (!res.ok) { logd("âŒ è®€å–å¤±æ•—", url, res.status); continue; }
          const json = await res.json();
          logd("âœ… è®€å–æˆåŠŸ", url);
          return json;
        }catch(e){
          logd("âš ï¸ è®€å–éŒ¯èª¤", url, String(e));
        }
      }
      throw new Error("æ‰€æœ‰è·¯å¾‘è®€å–çš†å¤±æ•—");
    }

    async function loadAssets() {
      setupAudios();
      const here = location.href;
      logd("ğŸ“„ é é¢ä½å€ï¼š", here);

      try {
        currentSourceKey = "base";
        const base = await fetchWithFallback(["é¡Œåº«.json","./é¡Œåº«.json"]);
        mergeIntoData(base, false);
        logd("âœ… é¡Œåº«.json è¼‰å…¥æˆåŠŸï¼Œæ–°å¢ï¼š", addedCounts.base);
      } catch (e) {
        logd("âš ï¸ é¡Œåº«.json è®€å–å¤±æ•—ï¼š", String(e));
      }
      try {
        currentSourceKey = "extra";
        const extra = await fetchWithFallback(["é¡å¤–é¡Œåº«.json","./é¡å¤–é¡Œåº«.json","extra.json","extras.json"]);
        mergeIntoData(extra, true);
        logd("âœ… é¡å¤–é¡Œåº« è¼‰å…¥æˆåŠŸï¼Œæ–°å¢ï¼š", addedCounts.extra);
      } catch (e) {
        logd("ï¼ˆå¯å¿½ç•¥ï¼‰é¡å¤–é¡Œåº« è®€å–å¤±æ•—ï¼š", String(e));
      }

      const totals = countTotals();
      const hasData = Object.values(DATA).some(map => Object.keys(map).length > 0);
      assetsReady = hasData;
      logd("ğŸ“Š è¼‰å…¥å¾Œçµ±è¨ˆï¼š", totals);

      const $loading = document.getElementById("loading");
      const $diagBtn = document.getElementById("diagBtn");
      if (assetsReady) {
        $loading.style.display = "none";
        document.getElementById("settings").style.display = "block";
        document.getElementById("startBtn").style.display = "inline-block";
        $diagBtn.style.display = "inline-block";
      } else {
        $loading.textContent = "âš ï¸ é¡Œåº«è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆèˆ‡è·¯å¾‘ã€‚";
        $diagBtn.style.display = "inline-block";
      }
      // å°‡åµéŒ¯è¨Šæ¯é¡¯ç¤ºæ–¼å€å¡Š
      const $diag = document.getElementById("diag");
      $diag.textContent = diag.join("\n");
    }
    function toggleDiag(){
      const box = document.getElementById('diag');
      box.style.display = (box.style.display === 'none' || box.style.display === '') ? 'block' : 'none';
    }
    loadAssets();

    // ===== éŠæˆ²ä¸»æµç¨‹ =====
    const MODE_COUNTS = {
      easy: { "æ˜“": 3, "ä¸­": 1, "é›£": 1 },
      medium: { "æ˜“": 1, "ä¸­": 3, "é›£": 1 },
      hard: { "æ˜“": 1, "ä¸­": 1, "é›£": 3 }
    };

    let currentBatch = [];
    let selectedWord = null;
    let countdown = null;
    let timeLeft = 0;
    let timers = [];
    let isActive = false;
    let postCountdown = null;
    let postTimeLeft = 0;
    let lastSuccess = null;

    function playAudio(id) {
      document.querySelectorAll('audio').forEach(a => { try { a.pause(); a.currentTime=0; } catch(e){} });
      const a = document.getElementById(id);
      if (a) { try { a.currentTime=0; a.play(); } catch(e){} }
    }
    function later(ms, fn) {
      const id = setTimeout(() => { if (!isActive) return; fn(); }, ms);
      timers.push(id);
      return id;
    }
    function clearAllTimers() { timers.forEach(clearTimeout); timers = []; }
    function stopAllAudio() { document.querySelectorAll('audio').forEach(a => { try { a.pause(); a.currentTime=0; } catch(e){} }); }
    function choice(arr) { return arr[Math.floor(Math.random()*arr.length)]; }
    function shuffle(a) { const arr=a.slice(); for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }

    function start() {
      if (!assetsReady) { alert("é¡Œåº«å°šæœªè¼‰å…¥å®Œæˆï¼"); return; }
      isActive = true;
      document.getElementById("settings").style.display = "none";
      const startBtn = document.getElementById("startBtn");
      startBtn.outerHTML = "<button id='stopBtn' class='stop' onclick='stopGame()'>åœæ­¢</button>";

      document.getElementById("result").innerHTML = "";
      document.getElementById("words").innerHTML = "";
      document.getElementById("chosen").innerHTML = "";
      document.getElementById("timer").innerHTML = "";
      document.getElementById("stage").innerHTML = "æº–å‚™ä¸­...";
      document.getElementById("postTimer").innerHTML = "";

      stopAllAudio(); clearAllTimers();

      playAudio("æº–å‚™");
      later(5000, () => {
        playAudio("ä¸»æŒäººèº«åˆ†");
        document.getElementById("stage").innerHTML = "<span class='big-label'>è«‹é¸æ“‡ä¸»æŒäººèº«åˆ†ï¼š</span>" +
          "<button class='word-btn' onclick=\\"chooseRole('seer')\\">é è¨€å®¶</button> " +
          "<button class='word-btn' onclick=\\"chooseRole('wolf')\\">ç‹¼äºº</button> " +
          "<button class='word-btn' onclick=\\"chooseRole('villager')\\">æ‘æ°‘</button>";
      });
    }

    function chooseRole(role) {
      if (!isActive) return;
      document.getElementById("stage").innerHTML = "";
      playAudio("é­”æ³•å’’èª");
      const mode = calculateDifficulty(role);
      logd("ğŸ¯ è¨ˆç®—é›£åº¦ â†’", mode);
      renderDiag();
      drawMode(mode);
    }

    // æ–°é›£åº¦å…¬å¼ï¼ˆ+0.325 & å€é–“å…§ç·šæ€§åˆ†ä½ˆï¼‰
    function calculateDifficulty(role) {
      let roleScore = 0;
      if (role === "seer") roleScore = 0;
      if (role === "wolf") roleScore = 0.5;
      if (role === "villager") roleScore = 1.5;

      const players = parseInt(document.getElementById("playerCount").value);
      const wolves = parseInt(document.getElementById("wolfCount").value);
      const P = players - wolves * 3;
      let playerScore = 0;
      if (P <= 1) playerScore = 0;
      else if (P === 2) playerScore = 0.75;
      else if (P >= 3) playerScore = 1.5;

      const rand = (Math.random() * 2 - 1);
      const total = roleScore + playerScore + rand + 0.325;

      if (total < 1) return "easy";
      if (total >= 3) return "hard";
      if (total >= 1 && total < 2) {
        const pMedium = total - 1; // 1â†’0, 2â†’1
        return (Math.random() < pMedium) ? "medium" : "easy";
      }
      // 2 â‰¤ total < 3
      const pHard = total - 2; // 2â†’0, 3â†’1
      return (Math.random() < pHard) ? "hard" : "medium";
    }

    function drawMode(mode) {
      const MODE_COUNTS = {
        easy: { "æ˜“": 3, "ä¸­": 1, "é›£": 1 },
        medium: { "æ˜“": 1, "ä¸­": 3, "é›£": 1 },
        hard: { "æ˜“": 1, "ä¸­": 1, "é›£": 3 }
      };
      const counts = MODE_COUNTS[mode];
      const diffsOrdered = Object.entries(counts).sort((a,b)=>b[1]-a[1]).map(x=>x[0]);
      const usedCats = new Set(); const batch = [];
      for (const diff of diffsOrdered) {
        let need = counts[diff];
        let categories = Object.keys(DATA[diff]||{}).filter(c => (DATA[diff][c]||[]).length>0 && !usedCats.has(c));
        categories = shuffle(categories).slice(0, need);
        for (const c of categories) {
          const w = choice(DATA[diff][c]);
          batch.push({word:w, category:c, difficulty:diff});
          usedCats.add(c);
        }
      }
      currentBatch = batch;
      logd("ğŸª„ æœ¬è¼ªå€™é¸å’’èªï¼š", currentBatch);
      renderDiag();
      renderBatch();
    }

    function renderBatch() {
      const container = document.getElementById("words");
      container.innerHTML = "<span class='big-label'>è«‹é¸æ“‡é­”æ³•å’’èªï¼š</span>";
      currentBatch.forEach(item => {
        const btn = document.createElement("button");
        btn.className = "word-btn";
        btn.textContent = item.word;
        btn.onclick = () => selectWord(item);
        container.appendChild(btn);
      });
    }

    function selectWord(item) {
      if (!isActive) return;
      selectedWord = item;
      document.getElementById("words").innerHTML = "";
      document.getElementById("chosen").innerHTML = "å’’èªï¼š" + selectedWord.word;
      logd("âœ… å·²é¸å’’èªï¼š", selectedWord);
      renderDiag();
      nightFlow();
    }

    function nightFlow() {
      playAudio("ä¸»æŒäººé–‰ä¸Šçœ¼ç›");
      later(5000, () => {
        playAudio("ç‹¼äººçœé–‹çœ¼ç›");
        document.getElementById("chosen").innerHTML = "å’’èªï¼š" + selectedWord.word;
        later(8000, () => {
          playAudio("ç‹¼äººé–‰ä¸Šçœ¼ç›");
          document.getElementById("chosen").innerHTML = "";
          later(5000, () => {
            playAudio("é è¨€å®¶çœé–‹çœ¼ç›");
            document.getElementById("chosen").innerHTML = "å’’èªï¼š" + selectedWord.word;
            later(8000, () => {
              playAudio("é è¨€å®¶é–‰ä¸Šçœ¼ç›");
              document.getElementById("chosen").innerHTML = "";
              later(5000, () => {
                playAudio("éŠæˆ²é–‹å§‹");
                document.getElementById("result").innerHTML = "éŠæˆ²é–‹å§‹ï¼";
                startCountdown();
              });
            });
          });
        });
      });
    }

    function startCountdown() {
      let minutes = parseInt(document.getElementById("timeInput").value);
      if (isNaN(minutes) || minutes < 1) minutes = 4;
      if (minutes > 10) minutes = 10;
      timeLeft = minutes * 60;
      updateTimer();
      countdown = setInterval(() => {
        if (!isActive) return;
        timeLeft--;
        updateTimer();
        if (timeLeft <= 0) {
          clearInterval(countdown);
          endGame(false);
        }
      }, 1000);
      document.getElementById("words").innerHTML = "<button class='word-btn' onclick='guessed()'>çŒœå°äº†</button>";
    }

    function updateTimer() {
      const m = Math.floor(timeLeft / 60);
      const s = timeLeft % 60;
      document.getElementById("timer").innerHTML = "å‰©é¤˜æ™‚é–“ï¼š" + m + "åˆ† " + (s<10?"0":"") + s + "ç§’";
    }

    function guessed() {
      if (!isActive) return;
      if (countdown) clearInterval(countdown);
      endGame(true);
    }

    function endGame(success) {
      isActive = false;
      clearAllTimers();
      stopAllAudio();
      if (countdown) clearInterval(countdown);
      document.getElementById("timer").innerHTML = "";
      document.getElementById("words").innerHTML = "";
      const stopBtn = document.getElementById("stopBtn");
      if (stopBtn) {
        stopBtn.outerHTML = "<button id='startBtn' onclick='resetGame()'>å†ä¾†ä¸€æ¬¡</button>";
      }
      const hasWord = selectedWord && selectedWord.word;
      lastSuccess = success;
      if (success && hasWord) {
        playAudio("çŒœåˆ°");
        document.getElementById("result").innerHTML = "ä½ å€‘çŒœåˆ°é­”æ³•å’’èªäº†ï¼âœ¨<br>å’’èªæ˜¯ï¼šã€Œ" + selectedWord.word + "ã€";
      } else if (hasWord) {
        playAudio("æœªçŒœåˆ°");
        document.getElementById("result").innerHTML = "ä½ å€‘æ²’æœ‰æ‰¾åˆ°é­”æ³•å’’èª ğŸ˜¢<br>æ­£ç¢ºå’’èªæ˜¯ï¼šã€Œ" + selectedWord.word + "ã€";
      } else {
        document.getElementById("result").innerHTML = "æœ¬è¼ªå·²åœæ­¢ã€‚";
      }
      if (hasWord) startPostCountdown();
    }

    function startPostCountdown() {
      postTimeLeft = 60;
      updatePostTimer();
      postCountdown = setInterval(() => {
        postTimeLeft--;
        updatePostTimer();
        if (postTimeLeft <= 0) {
          clearInterval(postCountdown);
          playAudio("æ™‚é–“åˆ°");
          document.getElementById("postTimer").innerHTML = "â° æ™‚é–“åˆ°ï¼";
        }
      }, 1000);
    }

    function updatePostTimer() {
      if (lastSuccess) {
        document.getElementById("postTimer").innerHTML = "ç‹¼äººæ‰¾å‡ºé è¨€å®¶å‰©é¤˜æ™‚é–“ï¼š" + (postTimeLeft<10?"0":"") + postTimeLeft + "ç§’";
      } else {
        document.getElementById("postTimer").innerHTML = "æ‰€æœ‰äººæ‰¾å‡ºç‹¼äººå‰©é¤˜æ™‚é–“ï¼š" + (postTimeLeft<10?"0":"") + postTimeLeft + "ç§’";
      }
    }

    function stopGame() { endGame(false); }

    function resetGame() {
      isActive = false;
      clearAllTimers();
      stopAllAudio();
      if (countdown) clearInterval(countdown);
      if (postCountdown) clearInterval(postCountdown);
      countdown = null;
      postCountdown = null;
      selectedWord = null;
      currentBatch = [];
      document.getElementById("stage").innerHTML = "";
      document.getElementById("words").innerHTML = "";
      document.getElementById("chosen").innerHTML = "";
      document.getElementById("timer").innerHTML = "";
      document.getElementById("result").innerHTML = "";
      document.getElementById("postTimer").innerHTML = "";
      document.getElementById("settings").style.display = "block";
      const btn = document.getElementById("startBtn");
      btn.textContent = "é–‹å§‹éŠæˆ²";
      btn.onclick = start;
    }

    function renderDiag(){
      const box = document.getElementById('diag');
      box.textContent = diag.join("\\n");
    }
  </script>
</body>
</html>
